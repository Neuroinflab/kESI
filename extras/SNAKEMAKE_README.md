# Snakefile Documentation

## Paths

Unless stated otherwise, all paths in this section are relative to the readme
directory, that is the _extras/_ directory of the working copy.


### Meshes

All meshes are stored in the _FEM/meshes_ directory containing a _Snakefile_
with mesh compilation workflows, _gmsh_ geometry files (_*.geo_) and their
templates (_*.geo.template_).

Most of compiled meshes are stored in the _FEM/meshes/meshes_ directory
which does not contain any tracked files, thus it may be softlinked or mounted
as a dedicated filesystem.  Paths to files in the directory follow pattern
_FEM/meshes/meshes/\<geometry\>/\<granularity\>\<suffix\>_
where:
- _\<geometry\>_ is the stem of the geometry template file
(_FEM/meshes/\<stem\>.geo.template_),
- _\<granularity\>_ is either of _coarsest_, _coarser_, _coarse_, _normal_,
  _fine_, _finer_, _finest_, _superfine_, _superfinest_ (in descending order
  of mesh granularity; other names are allowed for meshes of the same geometry
  but not derived from the geometry template),
- _suffix_ determines content of the file(files).

| suffix                                    | content               |
|-------------------------------------------|-----------------------|
| _.geo_                                    | _gmsh_ geometry       |
| _.msh_                                    | _gmsh_ mesh           |
| _.xdmf_ and _.h5_                         | _FEniCS_ mesh         |
| _\_subdomains.xdmf_ and _\_subdomains.h5_ | _FEniCS_ mesh domains |
| _\_boundaries.xdmf_ and _\_boundaries.h5_ | _FEniCS_ boundaries   |


### Solutions

Most of kESI data is stored in the _FEM/solutions_ directory.
It does not  contain any tracked files, thus it may be softlinked
or mounted as a dedicated filesystem.

The _FEM/solutions/tutorial_ directory contains tutorial-related data,
thus its content is discussed therein.

The _FEM/solutions/paper_ directory contains publication-related data.
For the sake of readability the **_FEM/solutions/paper_ path is omitted
in the further text**, that is all paths are relative to the root
of the _FEM/solutions/paper_ subtree unless stated otherwise.

Directories following pattern _\<geometry\>/\<granularity\>/\<degree\>/_
contain corrections of leadfields of electrodes, which are crucial for kESI.
File _\<geometry\>/\<granularity\>/\<degree\>/\<electrode\>.h5_ contains
correction of the leadfield of the electrode _\<electrode\>_ saved as a _FEniCS_
function and file _\<geometry\>/\<granularity\>/\<degree\>/\<electrode\>.ini_
contains its metadata.
File _\<geometry\>/\<granularity\>/\<degree\>/sampled/\<k\>/\<electrode\>.npz_
contains the **sampled leadfield correction** of the electrode saved in _NumPy_
format.  The correction is sampled on a regular, $(2^k + 1)^3$ grid.

Directories following pattern
_images/\<geometry\>/\<granularity\>/\<degree\>/kernels/\<k\>/_
contain kESI/kCSD kernel-related files derived from
_\<geometry\>/\<granularity\>/\<degree\>/sampled/\<k\>/*.npz_
sampled leadfields.

| file                           | content                                                        |
|--------------------------------|----------------------------------------------------------------|
| _electrodes.csv_               | positions of electrodes                                        |
| _src_mask.npz_                 | positions of source centroids                                  |
| _\<method\>\_phi.npz_          | the transfer matrix ($\Phi$) of _\<method\>_                   |
| _\<method\>\_kernel.npz_       | the kernel matrix of _\<method\>_                              |
| _\<method\>\_crosskernel.npz_  | the volumetric crosskernel tensor of _\<method\>_              |
| _\<method\>\_analysis.npz_     | auxilary analytical data of _\<method\>_                       |
| _\<method\>\_eigensources.npz_ | the volumetric eigensource tensor of _\<method\>_              |
| _fair\_sources.npz_            | average of appropriate volumetric eigensources of both methods |

_\<method\>_ may be either _kCSD_ or _kESI_.  Note that
_images/\<geometry\>/\<granularity\>/\<degree\>/kernels/\<k\>/kCSD\_*.npz_
files are redundant.

In the _images/\<geometry\>/\<granularity\>/\<degree\>/kernels/\<k\>/**images**_
subtree (_\<inverse model\>_) results of the forward modelling are stored.  File
_\<inverse model\>/\<geometry\>/\<granularity\>/\<degree\>/**\<sources\>**.csv_
contains potentials at the electrodes generated by CSD profiles from
_\<inverse model\>/../**\<sources\>**.npz_ with a FEM forward model appropriate
for the _\<geometry\>/\<granularity\>/\<degree\>_ subpath.


## Files

### Leadfield correction function

A _FEniCS_ 3D scalar function \[V/A\].

### Leadfield correction metadata

An _*.ini_ file.

| section    | field                     | value                                                |
|------------|---------------------------|------------------------------------------------------|
| fem        | mesh                      | path to the main mesh file                           |
|            | degree                    | degree of the element                                |
|            | element_type              | type of the element                                  |
| model      | config                    | path to model properties (conductivity etc.)         |
| electrode  | x                         | X coordinate of the point electrode                  |
|            | y                         | Y coordinate of the point electrode                  |
|            | z                         | Z coordinate of the point electrode                  |
| correction | global_preprocessing_time | location-independent preprocessing time \[s\]        |
|            | setup_time                | total function manager and FEM initiation time \[s\] |
|            | total_solving_time        | total time of location-dependent processing \[s\]    |
|            | local_preprocessing_time  | location-dependent preprocessing time \[s\]          |
|            | solving_time              | time of FEM equation solving \[s\]                   |
|            | base_conductivity         | base conductivity used by renormalization \[S/m\]    |
|            | filename                  | relative path to the correction function             |


### Sampled leadfield correction

A compressed NumPy file (_*.npz_).

| array                   | shape        | type          | content                                           |
|-------------------------|--------------|---------------|---------------------------------------------------|
| _CORRECTION\_POTENTIAL_ | (nx, ny, nz) | float \[V/A\] | sampled leadfield correction                      |
| _X_                     | (nx,)        | float \[m\]   | X nodes of the sampling grid                      |
| _Y_                     | (ny,)        | float \[m\]   | Y nodes of the sampling grid                      |
| _Z_                     | (nz,)        | float \[m\]   | Z nodes of the sampling grid                      |
| _LOCATION_              | (3,)         | float \[m\]   | X, Y, Z coordinates of the electrode              |
| _BASE\_CONDUCTIVITY_    | ()           | float \[S/m\] | base conductivity used by renormalization         |
| _\_PREPROCESSING\_TIME_ | ()           | float \[s\]   | construction time of the `FunctionManager` object |
| _\_LOADING\_TIME_       | ()           | float \[s\]   | loading time of the leadfield correction function |
| _\_PROCESSING\_TIME_    | ()           | float \[s\]   | leadfield correction sampling time                |


### Positions of source centroids

| array    | shape        | type        | content                      |
|----------|--------------|-------------|------------------------------|
| _MASK_   | (nx, ny, nz) | bool        | mask of nodes with centroids |
| _X_      | (nx, 1, 1)   | float \[m\] | X nodes of the centroid grid |
| _Y_      | (1, ny, 1)   | float \[m\] | Y nodes of the centroid grid |
| _Z_      | (1, 1, nz)   | float \[m\] | Z nodes of the centroid grid |

`MASK.sum() == m` where `m` is the number of base functions.
